<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Radarové zrážky (RainViewer) | Meteo</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  />
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
    .controls {
      position:absolute;
      top:10px; left:50%;
      transform:translateX(-50%);
      z-index:1000;
      background: rgba(255,255,255,0.8);
      padding:10px;
      border-radius:8px;
      display:flex;
      gap:8px;
    }
    .controls button, .controls select {
      padding:6px 10px;
      border:none;
      border-radius:4px;
      cursor:pointer;
      font-size:14px;
    }
    #timestamp {
      position:absolute;
      bottom:12px; left:50%;
      transform:translateX(-50%);
      z-index:1000;
      background:rgba(0,0,0,0.6);
      color:#fff;
      padding:4px 8px;
      border-radius:4px;
      font-size:12px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="controls">
    <button id="prev"><i class="fas fa-backward"></i></button>
    <button id="play"><i class="fas fa-play"></i></button>
    <button id="next"><i class="fas fa-forward"></i></button>
    <select id="overlaySelect">
      <option value="radar">Zrážky</option>
      <option value="snow">Sneh</option>
    </select>
  </div>
  <div id="timestamp">Načítavam…</div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://kit.fontawesome.com/a4130fa7fd.js" crossorigin="anonymous"></script>
  <script>
    const map = L.map('map').setView([48.15, 17.11], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let apiData, frames = [], current = 0, timer = null, overlayLayer;

    // 1) Stiahneme JSON
    fetch('https://api.rainviewer.com/public/maps.json')
      .then(r => r.json())
      .then(data => {
        apiData = data;
        buildFrameList();
        initControls();
        showFrame(0);
      })
      .catch(console.error);

    // 2) Z idx selectu vytvoríme pole snímok
    function buildFrameList() {
      const sel = document.getElementById('overlaySelect').value;
      // vyber minulé + nowcast
      const section = apiData[sel];
      const list = (section.past||[]).concat(section.nowcast||[]);
      // každý frame má time + url template
      frames = list.map(f => ({
        time: f.time,
        url: apiData.host + f.path + '/{z}/{x}/{y}.png'
      }));
    }

    function initControls() {
      document.getElementById('prev').onclick = () => changeFrame(-1);
      document.getElementById('next').onclick = () => changeFrame(1);
      document.getElementById('play').onclick = togglePlay;
      document.getElementById('overlaySelect').onchange = () => {
        clearInterval(timer);
        timer = null;
        document.getElementById('play').innerHTML = '<i class="fas fa-play"></i>';
        current = 0;
        if (overlayLayer) map.removeLayer(overlayLayer);
        buildFrameList();
        showFrame(0);
      };
    }

    function showFrame(idx) {
      current = (idx + frames.length) % frames.length;
      const frame = frames[current];
      if (overlayLayer) map.removeLayer(overlayLayer);
      // vložíme templated URL dlaždíc
      overlayLayer = L.tileLayer(frame.url, {
        tileSize: 256,
        opacity: 0.6,
        zIndex: 500
      }).addTo(map);
      document.getElementById('timestamp').innerText =
        new Date(frame.time * 1000).toLocaleString('sk');
    }

    function changeFrame(d) { showFrame(current + d); }

    function togglePlay() {
      const btn = document.getElementById('play');
      if (timer) {
        clearInterval(timer);
        timer = null;
        btn.innerHTML = '<i class="fas fa-play"></i>';
      } else {
        timer = setInterval(() => showFrame(current + 1), 1000);
        btn.innerHTML = '<i class="fas fa-pause"></i>';
      }
    }
  </script>
</body>
</html>
